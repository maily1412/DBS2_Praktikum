SQL> 
SQL> -- ==========================================================
SQL> -- Wenn ich das Skript mehrmals ausführe, lösche ich die Tabelle zuerst
SQL> -- ==========================================================
SQL> 
SQL> DROP TABLE Staedte CASCADE CONSTRAINTS;

Table STAEDTE dropped.

SQL> 
SQL> -- ==========================================================
SQL> -- Aufgabe 1a
SQL> -- Tabelle Stadte erstellen
SQL> -- ==========================================================
SQL> 
SQL> -- Einheiten: 
SQL> -- Stadtname: Text (VARCHAR2)
SQL> -- Breitengrad: Dezimalgrad (NUMBER) - Latitude in Grad
SQL> -- Längengrad: Dezimalgrad (NUMBER) - Longitude in Grad
SQL> 
SQL> CREATE TABLE Staedte (
  2      Stadtname VARCHAR(50) PRIMARY KEY,      -- Name der Stadt
  3      Breitengrad NUMBER(10,2),          -- Breitengrad  in Dezimal
  4      Laengengrad NUMBER(10,2)      -- Längengrad in Dezimal
  5  
  6  );

Table STAEDTE created.

SQL> 
SQL> -- ==========================================================
SQL> -- Aufgabe 1b
SQL> -- Daten in die Tabelle Städte einfügen
SQL> -- ==========================================================
SQL> 
SQL> -- View erstellen zur Zeilenaufteilung
SQL> CREATE OR REPLACE VIEW staedte_lines 
  2  AS
  3  WITH rws AS(
  4      SELECT data
  5      AS str
  6      FROM user001.webservice_loads
  7      WHERE id = 2
  8  )    
  9  -- Splitten von Texten
 10  SELECT TRIM(REGEXP_SUBSTR(
 11           str,
 12           '[^.]+',         -- alles bis zum nächsten Punkt
 13           1,
 14           LEVEL
 15         )) AS value
 16  FROM rws
 17  CONNECT BY LEVEL <= LENGTH(TRIM(BOTH '.' FROM str)) - LENGTH(REPLACE(str, '.')) + 1;

View STAEDTE_LINES created.

SQL> 
SQL> -- Der CONNECT BY-Teil sorgt dafür, dass jede Zeile bis zum nächsten Punkt extrahiert wird.
SQL> 
SQL> -- Schauen ab welcher Position die Werte beginnne
SQL> DECLARE
  2    line VARCHAR2(4000);
  3  BEGIN 
  4       -- Jede Zeile aus der View durchlaufen
  5    FOR r IN (SELECT value FROM staedte_lines) LOOP 
  6     -- Zeilenumbruch entfernen
  7      line := REPLACE(REPLACE(r.value, CHR(10), ''), CHR(13), '');
  8  
  9   -- Die folgenden Zeilen testen, an welcher Position im String sich die Werte befinden
 10      DBMS_OUTPUT.PUT_LINE(SUBSTR(line, 1, 2));        -- Grad Nord
 11      DBMS_OUTPUT.PUT_LINE('m:'||SUBSTR(line, 5, 2));  -- Minuten Nord
 12      DBMS_OUTPUT.PUT_LINE('g:'||SUBSTR(line, 12, 1)); -- Grad Ost
 13      DBMS_OUTPUT.PUT_LINE('m:'||SUBSTR(line, 15, 2)); -- Minuten Ost
 14      DBMS_OUTPUT.PUT_LINE('s:'||SUBSTR(line, 22));    -- Stadtname
 15    END LOOP;
 16  END;
 17  /
50
m:47
g:6
m: 5
s:Aachen
50
m:44
g:7
m: 6
s:Bonn
51
m:14
g:6
m:47
s:Düsseldorf
51
m:25
g:6
m:46
s:Duisburg
51
m:27
g:7
m: 1
s:Essen
50
m:56
g:6
m:57
s:Köln
51
m:20
g:6
m:34
s:Krefeld
51
m: 2
g:6
m:59
s:Leverkusen
51
m:11
g:6
m:27
s:Mönchengladbach
51
m:26
g:6
m:53
s:Mülheim an der Ruhr
51
m:28
g:6
m:52
s:Oberhausen
51
m:11
g:7
m:12
s:Remscheid
51
m:10
g:7
m: 5
s:Solingen
51
m:16
g:7
m:13
s:Wuppertal


PL/SQL procedure successfully completed.

SQL> 
SQL> -- Daten in die Tabelle Städte einfügen
SQL> DECLARE
  2      v_line VARCHAR2(1000);
  3      n_g NUMBER(10,2);
  4      n_m NUMBER(10,2);
  5      o_g NUMBER(10,2);
  6      o_m NUMBER(10,2);
  7      stadtname VARCHAR2(100);
  8  BEGIN
  9      FOR r IN (SELECT value FROM staedte_lines) LOOP 
 10           -- Zeilenumbrüche entfernen
 11          v_line := REPLACE(REPLACE(r.value, CHR(10), ''), CHR(13), '');
 12  
 13          -- Einzelne Werte aus der Textzeile an den jeweiligen Positionen auslesen
 14          n_g := TO_NUMBER(SUBSTR(v_line, 1, 2));        -- Grad Nord
 15          n_m := TO_NUMBER(SUBSTR(v_line, 5, 2));        -- Minuten Nord
 16          o_g := TO_NUMBER(SUBSTR(v_line, 12, 1));       -- Grad Ost
 17          o_m := TO_NUMBER(SUBSTR(v_line, 15, 2));       -- Minuten Ost
 18          stadtname := SUBSTR(v_line, 22);               -- Stadtname
 19  
 20          -- Umrechnung Minuten --> Dezimal 
 21          INSERT INTO Staedte (Stadtname, Breitengrad, Laengengrad)
 22          VALUES (
 23              stadtname,
 24              n_g + n_m / 60,     -- Nordkoordinate in Dezimal
 25              o_g + o_m / 60      -- Ostkoordinate in Dezimal
 26          );
 27      END LOOP;
 28  END;
 29  /

PL/SQL procedure successfully completed.

SQL> 
SQL> -- Test: Alle Daten aus der Tabelle Städte anzeigen
SQL> Select * From Staedte;

STADTNAME                                          BREITENGRAD LAENGENGRAD
-------------------------------------------------- ----------- -----------
Aachen                                                   50,78        6,08
Bonn                                                     50,73         7,1
Düsseldorf                                               51,23        6,78
Duisburg                                                 51,42        6,77
Essen                                                    51,45        7,02
Köln                                                     50,93        6,95
Krefeld                                                  51,33        6,57
Leverkusen                                               51,03        6,98
Mönchengladbach                                          51,18        6,45
Mülheim an der Ruhr                                      51,43        6,88
Oberhausen                                               51,47        6,87

STADTNAME                                          BREITENGRAD LAENGENGRAD
-------------------------------------------------- ----------- -----------
Remscheid                                                51,18         7,2
Solingen                                                 51,17        7,08
Wuppertal                                                51,27        7,22

14 rows selected. 

SQL> 
SQL> -- ==========================================================
SQL> -- Aufgabe 1c
SQL> -- Funktion: Abstand zwischen zwei Städten (km, mit Erdkrümmung)
SQL> -- ==========================================================
SQL> 
SQL> CREATE OR REPLACE FUNCTION abstand (a staedte%ROWTYPE, b staedte%ROWTYPE)
  2  RETURN NUMBER
  3  AS
  4      dist_y NUMBER(10,5);        -- Nord-Süd-Distanz
  5      dist_x NUMBER(10,5);        -- Ost-West-Distanz
  6      rad CONSTANT NUMBER := ACOS(-1) / 180; -- Grad --> Radiant-Umrechnungsfaktor
  7      erdradius CONSTANT NUMBER := 6371;     -- Erdradius in km
  8      distanz NUMBER(10,2);
  9  BEGIN
 10   -- Längengrad-Differenz, korrigiert um den Cosinus des mittleren Breitengrads zu ermitteln
 11      dist_x := (b.Laengengrad - a.Laengengrad) * COS((a.Breitengrad + b.Breitengrad) / 2 * rad);
 12  
 13      -- Differenz der Breitengrade (Nord-Süd)
 14      dist_y := b.Breitengrad - a.Breitengrad;
 15  
 16      -- Pythagoras auf der Kugeloberfläche, dann in km umrechnen
 17      distanz := erdradius * rad * SQRT(dist_x * dist_x + dist_y * dist_y);
 18  
 19      RETURN ROUND(distanz, 2);
 20  END abstand;
 21  /

Function ABSTAND compiled

No errors.
SQL> 
SQL> -- Test: Entfernung zwischen Düsseldorf und Köln
SQL> DECLARE
  2      stadt_a staedte%ROWTYPE;
  3      stadt_b staedte%ROWTYPE;
  4      entfernung NUMBER;
  5  BEGIN
  6    -- Daten für Düsseldorf und Köln aus Tabelle holen
  7      SELECT * INTO stadt_a FROM Staedte WHERE Stadtname = 'Düsseldorf';
  8      SELECT * INTO stadt_b FROM Staedte WHERE Stadtname = 'Köln';
  9  
 10      -- Abstand berechnen
 11      entfernung := abstand(stadt_a, stadt_b);
 12  
 13      DBMS_OUTPUT.PUT_LINE('Entfernung zwischen Düsseldorf und Köln: ' ||  entfernung || ' km');
 14  END;
 15  /
Entfernung zwischen Düsseldorf und Köln: 35,41 km


PL/SQL procedure successfully completed.

SQL> 
SQL> -- ==========================================================
SQL> -- Aufgabe 1d
SQL> -- Prozedur: Entfernungstabelle (nutzt meine ROWTYPE-Funktion abstand)
SQL> -- ==========================================================
SQL> CREATE OR REPLACE PROCEDURE entfernungs_tabelle AS
  2  BEGIN
  3    -- Überschrift: 2-Buchstaben-Kürzel je Stadt
  4    DBMS_OUTPUT.PUT('-                  ');
  5    FOR stadt IN (SELECT * FROM Staedte ORDER BY Stadtname) LOOP
  6      DBMS_OUTPUT.PUT(LPAD(SUBSTR(stadt.Stadtname, 1, 2), 10));
  7    END LOOP;
  8    DBMS_OUTPUT.NEW_LINE;
  9  
 10    -- Matrix: Zeile = Ausgangsstadt, Spalte = Zielstadt
 11    FOR stadt IN (SELECT * FROM Staedte ORDER BY Stadtname) LOOP
 12      DBMS_OUTPUT.PUT(RPAD(stadt.Stadtname, 20));
 13      FOR ziel IN (SELECT * FROM Staedte ORDER BY Stadtname) LOOP
 14        -- wichtig: TO_CHAR mit Format-Model, nicht „10”
 15        DBMS_OUTPUT.PUT(LPAD(TO_CHAR(abstand(stadt, ziel), 'FM9990.00'), 10));
 16      END LOOP;
 17      DBMS_OUTPUT.NEW_LINE;
 18    END LOOP;
 19  END;
 20  /

Procedure ENTFERNUNGS_TABELLE compiled

No errors.
SQL> 
SQL> -- Test: Entfernungstabelle ausgeben
SQL> EXECUTE entfernungs_tabelle();
-                          Aa        Bo        Du        Dü        Es        Kr        Kö        Le        Mö        Mü        Ob        Re        So        Wu
Aachen                    0.00     71.97     85.94     70.02     99.28     70.09     63.31     68.96     51.47     91.34     94.48     90.14     82.36     96.57
Bonn                     71.97      0.00     80.11     59.94     80.26     76.32     24.61     34.40     67.65     79.34     83.84     50.53     48.95     60.63
Duisburg                 85.94     80.11      0.00     21.14     17.65     17.11     55.91     45.77     34.74      7.71      8.89     40.07     35.18     35.43
Düsseldorf               70.02     59.94     21.14      0.00     29.60     18.36     35.41     26.26     23.65     23.30     27.41     29.78     21.94     30.95
Essen                    99.28     80.26     17.65     29.60      0.00     33.96     58.03     46.78     49.71      9.96     10.63     32.52     31.41     24.36
Krefeld                  70.09     76.32     17.11     18.36     33.96      0.00     51.78     43.93     18.65     24.22     25.99     46.91     39.70     45.68
Köln                     63.31     24.61     55.91     35.41     58.03     51.78      0.00     11.32     44.66     55.81     60.30     32.83     28.19     42.25
Leverkusen               68.96     34.40     45.77     26.26     46.78     43.93     11.32      0.00     40.59     45.02     49.52     22.67     17.06     31.50
Mönchengladbach          51.47     67.65     34.74     23.65     49.71     18.65     44.66     40.59      0.00     40.82     43.49     52.28     43.93     54.55
Mülheim an der Ruhr      91.34     79.34      7.71     23.30      9.96     24.22     55.81     45.02     40.82      0.00      4.50     35.60     32.08     29.56
Oberhausen               94.48     83.84      8.89     27.41     10.63     25.99     60.30     49.52     43.49      4.50      0.00     39.57     36.41     32.94
Remscheid                90.14     50.53     40.07     29.78     32.52     46.91     32.83     22.67     52.28     35.60     39.57      0.00      8.44     10.10
Solingen                 82.36     48.95     35.18     21.94     31.41     39.70     28.19     17.06     43.93     32.08     36.41      8.44      0.00     14.79
Wuppertal                96.57     60.63     35.43     30.95     24.36     45.68     42.25     31.50     54.55     29.56     32.94     10.10     14.79      0.00


PL/SQL procedure successfully completed.

SQL> 
SQL> SPool OFF;
